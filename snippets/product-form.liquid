{%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}
{%- assign color_white_label = 'general.label.white' | t | downcase -%}
{%- assign size_label_list = 'general.label.size' | t | replace: ', ', ',' | downcase | split: ',' -%}
{%- assign product_form_id = 'product-form-' | append: section.id | append: '-' | append: product.id -%}

<div class="product-form">
  {%- for block in section.blocks -%}
    {%- case block.type -%}
      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      APP BLOCK TYPE
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when '@app' -%}
        {%- render block -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      VARIANT PICKER BLOCK TYPE
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'variant_picker' -%}
      {%- for variant in product.variants -%}
            {% if variant.metafields.data.shown == false %}
              {% assign toShow = toShow | append: variant.id %}
              {% assign toShow = toShow | append: ' ' %}
            {% endif %}
          {%- endfor -%}
          {% assign hideVariants = toShow | split:' ' %}
      <script>
        var hideVariants = {{ hideVariants | json}};
        //console.log(hideVariants);
      </script>
        {%- unless product.has_only_default_variant or block.settings.hide_sold_out_variants and product.available == false -%}
          {%- assign size_chart_page = block.settings.size_chart_page -%}
          {%- assign found_size_option = false -%}

          <product-variants handle="{{ product.handle }}" form-id="{{ product_form_id }}" {% if update_url %}update-url{% endif %} {% if block.settings.hide_sold_out_variants %}hide-sold-out-variants{% endif %} class="product-form__variants" {{ block.shopify_attributes }}>
            {%- for option in product.options_with_values -%}
              {%- assign option_downcase = option.name | downcase -%}
              {%- capture option_id -%}option-{{ section.id }}-{{ template.suffix }}-{{ product.id }}-{{ forloop.index }}{%- endcapture -%}

              {%- assign selector_type = block.settings.selector_mode -%}

              {% if color_label_list contains option_downcase %}
                {%- assign selector_type = block.settings.color_mode -%}

                {%- if selector_type == 'variant_image' -%}
                  {%- comment -%}To use this mode every variant must have an attached media{%- endcomment -%}
                  {%- for variant in product.variants -%}
                    {%- unless variant.featured_media -%}
                      {%- assign selector_type = 'color' -%}
                      {%- break -%}
                    {%- endunless -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endif -%}

              <div class="product-form__option-selector" style="display:none;" data-selector-type="{{ selector_type | replace: '_', '-' | escape }}">
                <div class="product-form__option-info">
                  <span class="product-form__option-name">{{ option.name }}:</span>

                  {%- if selector_type != 'dropdown' -%}
                    <span id="{{ option_id }}-value" class="product-form__option-value">{{ option.selected_value }}</span>
                  {%- endif -%}

                  {%- if size_chart_page != blank and size_label_list contains option_downcase -%}
                    {%- assign found_size_option = true -%}
                    <button type="button" is="toggle-button" class="product-form__option-link link text--subdued hidden-phone" aria-controls="product-{{ section.id }}-{{ product.id }}-size-chart-drawer" aria-expanded="false">{{ 'product.general.size_chart' | t }}</button>
                    <button type="button" is="toggle-button" class="product-form__option-link link text--subdued hidden-tablet-and-up" aria-controls="product-{{ section.id }}-{{ product.id }}-size-chart-popover" aria-expanded="false">{{ 'product.general.size_chart' | t }}</button>
                  {%- endif -%}
                </div>

                {%- case selector_type -%}
                  {%- when 'variant_image' -%}
                    <div class="variant-swatch-list">
                      {%- assign option_position0 = option.position | minus: 1 -%}

                      {%- for value in option.values -%}
                        {%- comment -%}We search for the first variant that has an image for this color{%- endcomment -%}
                        {%- for variant in product.variants -%}
                          {%- if variant.options[option_position0] == value -%}
                            <div class="variant-swatch">
                              <input class="variant-swatch__radio visually-hidden" type="radio" name="option{{ option.position }}" form="{{ product_form_id }}" id="{{ option_id }}-{{ forloop.index }}" value="{{ value | escape }}" data-bind-value="{{ option_id }}-value" {% if value == option.selected_value %}checked="checked"{% endif %} aria-label="{{ value | escape }}">
                              <label class="variant-swatch__item" for="{{ option_id }}-{{ forloop.index }}">
                                <span class="visually-hidden">{{ value }}</span>
                                <img class="variant-swatch__image" loading="lazy" sizes="(max-width: 740px) 64px, 72px" {% render 'image-attributes', image: variant.featured_media, sizes: '64,72,128,144,192,216' %}>
                              </label>
                            </div>
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                      {%- endfor -%}
                    </div>

                  {%- when 'color' -%}
                    <div class="color-swatch-list">
                      {%- assign color_swatch_config = settings.color_swatch_config | newline_to_br | split: '<br />' -%}

                      {%- for value in option.values -%}
                        {%- assign color_value_downcase = value | downcase -%}

                        <div class="color-swatch {% if color_white_label == color_value_downcase %}color-swatch--white{% endif %}">
                          <input class="color-swatch__radio visually-hidden" type="radio" name="option{{ option.position }}" form="{{ product_form_id }}" id="{{ option_id }}-{{ forloop.index }}" value="{{ value | escape }}" {% if value == option.selected_value %}checked="checked"{% endif %} data-bind-value="{{ option_id }}-value">
                          <label class="color-swatch__item" for="{{ option_id }}-{{ forloop.index }}" style="{% render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value %}">
                            <span class="visually-hidden">{{ value }}</span>
                          </label>
                        </div>
                      {%- endfor -%}
                    </div>

                  {%- when 'block' -%}
                    <div class="block-swatch-list">
                      {%- for value in option.values -%}
                        <div class="block-swatch">
                          <input class="block-swatch__radio visually-hidden" type="radio" name="option{{ option.position }}" form="{{ product_form_id }}" id="{{ option_id }}-{{ forloop.index }}" value="{{ value | escape }}" {% if value == option.selected_value %}checked="checked"{% endif %} data-bind-value="{{ option_id }}-value">
                          <label class="block-swatch__item" for="{{ option_id }}-{{ forloop.index }}">{{ value }}</label>
                        </div>
                      {%- endfor -%}
                    </div>

                  {%- when 'dropdown' -%}
                    <div class="select-wrapper">
                      <combo-box initial-focus-selector="[aria-selected='true']" id="{{ option_id }}-combo-box" class="combo-box">
                        <span class="combo-box__overlay"></span>

                        <header class="combo-box__header">
                          <p class="combo-box__title heading h6">{{ option.name }}</p>

                          <button type="button" class="combo-box__close-button tap-area" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
                            {%- render 'icon' with 'close' -%}
                          </button>
                        </header>

                        <div class="combo-box__option-list" role="listbox">
                          {%- for value in option.values -%}
                            <button type="button" role="option" class="combo-box__option-item" value="{{ value | escape }}" aria-selected="{% if value == option.selected_value %}true{% else %}false{% endif %}">{{ value }}</button>
                          {%- endfor -%}
                        </div>

                        <select class="visually-hidden" name="option{{ option.position }}" form="{{ product_form_id }}" data-bind-value="{{ option_id }}-value" aria-label="{{ option.name | escape }}">
                          {%- for value in option.values -%}
                            <option value="{{ value | escape }}" {% if value == option.selected_value %}selected{% endif %}>{{ value }}</option>
                          {%- endfor -%}
                        </select>
                      </combo-box>

                      <button type="button" is="toggle-button" class="select" aria-expanded="false" aria-haspopup="listbox" aria-controls="{{ option_id }}-combo-box">
                        <span id="{{ option_id }}-value" class="select__selected-value">{{ option.selected_value }}</span>
                        {%- render 'icon' with 'chevron' -%}
                      </button>
                    </div>
                {%- endcase -%}
              </div>
            {%- endfor -%}

            <noscript>
              <label class="input__block-label" for="product-select-{{ section.id }}-{{ product.id }}">{{ 'product.form.variant' | t }}</label>

              <div class="select-wrapper">
                <select class="select" autocomplete="off" id="product-select-{{ section.id }}-{{ product.id }}" name="id" form="{{ product_form_id }}">
                  {%- for variant in product.variants -%}
                    <option {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %} {% unless variant.available %}disabled="disabled"{% endunless %} value="{{ variant.id }}" data-sku="{{ variant.sku }}">{{ variant.title }} - {{ variant.price | money }} </option>
                  {%- endfor -%}
                </select>

                {%- render 'icon' with 'chevron' -%}
              </div>
            </noscript>
          </product-variants>
        {%- endunless -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      LINE ITEM PROPERTY
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'line_item_property' -%}
        {%- if block.settings.label != blank -%}
          {%- case block.settings.type -%}
            {%- when 'text' -%}
              {%- if block.settings.allow_long_text -%}
                <div class="product-form__line-item-property" {{ block.shopify_attributes }}>
                  <label class="input__block-label" for="line-item-{{ section.id }}-{{ block.id }}">{{ block.settings.label | escape }}:</label>
                  <textarea {% if block.settings.required %}required{% endif %} id="line-item-{{ section.id }}-{{ block.id }}" form="{{ product_form_id }}" class="input__field input__field--textarea" name="properties[{{ block.settings.label | escape }}]"></textarea>
                </div>
              {% else %}
                <div class="product-form__line-item-property" {{ block.shopify_attributes }}>
                  <label class="input__block-label" for="line-item-{{ section.id }}-{{ block.id }}">{{ block.settings.label | escape }}:</label>
                  <input {% if block.settings.required %}required{% endif %} id="line-item-{{ section.id }}-{{ block.id }}" form="{{ product_form_id }}" type="text" class="input__field" name="properties[{{ block.settings.label | escape }}]">
                </div>
              {%- endif -%}

            {%- when 'checkbox' -%}
              <div class="product-form__line-item-property" {{ block.shopify_attributes }}>
                <div class="checkbox-container">
                  <input type="hidden" form="{{ product_form_id }}" class="checkbox" name="properties[{{ block.settings.label | escape }}]" value="{{ block.settings.unchecked_value | escape }}">
                  <input type="checkbox" form="{{ product_form_id }}" class="checkbox" name="properties[{{ block.settings.label | escape }}]" id="line-item-{{ section.id }}-{{ block.id }}" value="{{ block.settings.checked_value | escape }}">
                  <label for="line-item-{{ section.id }}-{{ block.id }}">{{ block.settings.label | escape }}</label>
                </div>
              </div>
          {%- endcase -%}
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      TEXT
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'text' -%}
        {% if block.settings.text != blank %}
          <div class="product-form__text" {{ block.shopify_attributes }}>
            {{- block.settings.text -}}
          </div>
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      IMAGE
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'image' -%}
      {% if block.settings.image != blank %}
        <div class="product-form__image product-form__image--{{ block.settings.image_alignment }}" {{ block.shopify_attributes }}>
          {%- capture image_sizes -%}{{ block.settings.image_width }}, {{ block.settings.image_width | times: 2 }}, {{ block.settings.image_width | times: 3 }}{%- endcapture -%}
          <img loading="lazy" style="max-width: {{ block.settings.image_width }}px" {% render 'image-attributes', image: block.settings.image, sizes: image_sizes %}>
        </div>
      {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      BUTTON
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'button' -%}
        {% if block.settings.link != blank and block.settings.text != blank %}
          <div class="product-form__button" {{ block.shopify_attributes }}>
            {%- if block.settings.background == 'rgba(0,0,0,0)' -%}
              {%- assign button_background = settings.primary_button_background -%}
            {%- else -%}
              {%- assign button_background = block.settings.background -%}
            {%- endif -%}

            {%- if block.settings.text_color == 'rgba(0,0,0,0)' -%}
              {%- assign button_text_color = settings.primary_button_text_color -%}
            {%- else -%}
              {%- assign button_text_color = block.settings.text_color -%}
            {%- endif -%}

            {%- capture button_background_rgb -%}{{ button_background.red }}, {{ button_background.green }}, {{ button_background.blue }}{%- endcapture -%}
            {%- capture button_text_color_rgb -%}{{ button_text_color.red }}, {{ button_text_color.green }}, {{ button_text_color.blue }}{%- endcapture -%}

            <a href="{{ block.settings.link }}" class="button button--primary {% if block.settings.stretch %}button--full{% endif %}" style="--primary-button-background: {{ button_background_rgb }}; --primary-button-text-color: {{ button_text_color_rgb }}">{{ block.settings.text | escape }}</a>
          </div>
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      CUSTOM LIQUID
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'liquid' -%}
        {% if block.settings.liquid != blank %}
          <div class="product-form__custom-liquid" {{ block.shopify_attributes }}>
            {{- block.settings.liquid -}}
          </div>
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      QUANTITY SELECTOR
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'quantity_selector' -%}
        {%- if request.page_type != 'password' and product.available -%}
          <div class="product-form__quantity" {{ block.shopify_attributes }}>
            <span class="product-form__quantity-label text--subdued text--xsmall">
              {% assign pack = product.selected_or_first_available_variant.metafields.data.quantity_in_pack | times:1 %}
              {% if pack > 1 %}
                Sold in boxes of {{ product.selected_or_first_available_variant.metafields.data.quantity_in_pack }}
              {% else %}
                Qty:
              {% endif %}
            	  {% comment %}{{ 'product.form.quantity' | t }}{% assign current_variant = product.selected_or_first_available_variant %}{% assign bundled_variants = current_variant.metafields.simple_bundles.bundled_variants.value %}{% assign number_bundle_items = 0 %}{% for bundled_variant in bundled_variants %}{% assign number_bundle_items = number_bundle_items | plus: 1 %}{% endfor %}{% if number_bundle_items == 1 %}{% for bundled_variant in bundled_variants %} of packs{% endfor %}{% endif %}:
          {% endcomment %}
          {% assign min_qty = product.metafields.data.minqty.value %}
          {% assign minqty = min_qty[0] | plus: 0 %}
              
          {% if product.selected_or_first_available_variant.metafields.data.quantity_in_pack %}
            {% assign qtySteps = product.selected_or_first_available_variant.metafields.data.quantity_in_pack  %}
          {% else %}
            {% assign qtySteps = 1  %}
          {% endif %}
              
          {% if minqty != '' and minqty >= 2 %}
            <strong>&nbsp;[ Min Purchase Qty = {{ minqty }} ]</strong>
          {% endif %}
            </span>

            <quantity-selector class="quantity-selector">
              <button type="button" class="quantity-selector__button">
                <span class="visually-hidden">{{ 'cart.general.decrease_quantity' | t }}</span>
                {%- render 'icon' with 'minus-big' -%}
              </button>

              <input type="text" 
                form="{{ product_form_id }}" 
                is="input-number" 
                class="quantity-selector__input" 
                inputmode="numeric" 
                name="quantity" 
                autocomplete="off" 
                min="0"
                value="{% if minqty != '' and minqty >= 2 %}
                  {{ minqty }}
                  {% else %}{{ qtySteps }}{% endif %}" 
                step="{{ qtySteps }}"
                onblur="validateAndCorrectInputProd(this)"
                size="2" 
                aria-label="{{ 'product.form.quantity' | t | escape }}">

              <button type="button" class="quantity-selector__button">
                <span class="visually-hidden">{{ 'cart.general.increase_quantity' | t }}</span>
                {%- render 'icon' with 'plus-big' -%}
              </button>
            </quantity-selector>
            
            <script>
              function validateAndCorrectInputProd(input) {
                let value = input.value;     
                if (value % {{ qtySteps }} !== 0) {
                  let correctedValue = Math.round(value / {{ qtySteps }}) * {{ qtySteps }};
                  input.value = correctedValue;
                }
              }

              const qtySelector = $('.quantity-selector');         
              qtySelector.on("click", "button:first-child", () => {
                var qty = $("input[name='quantity']");
                qty[0].quantity = qty[0].quantity - {{ qtySteps }};
              });
              
              qtySelector.on("click", "button:last-child", () => {
                var qty = $("input[name='quantity']");
                qty[0].quantity = qty[0].quantity + {{ qtySteps }};
              });
            </script>

          {%  comment %}BUY BUTTON{% endcomment %}
            {%- if request.page_type != 'password' -%}
              <div class="product-form__buy-buttons" {{ block.shopify_attributes }}>
                {%- form 'product', product, is: 'product-form', id: product_form_id, data-type: "add-to-cart-form" -%}
                  <input type="hidden" disabled name="id" value="{{ product.selected_or_first_available_variant.id }}">
                  {%- assign currentVariant = product.selected_or_first_available_variant %}
                  {%- assign massBB = currentVariant.metafields.mas_bb_disp.state.value %}
                  {%- if quickview == "yes" and currentVariant.available -%}
                    {%- if massBB.status == "backordered" and massBB.left < 1 and massBB.limit > 0 and massBB.is_backorderable -%}
                      <input type="hidden" name="properties[{{- shop.metafields.mas_bb_config.settings.value.display_preorder -}}]" value="{{- massBB.label -}}" data-mas-backstock-property-label="true">
                    {%- endif -%}
                  {%- endif -%}
                  
                  {%  comment %}START Shipping Time Frame{% endcomment %}
                  <div class="over_button_text">
                    <em>
                      {% assign target_tags = "MaxLite,Mester,XSY LIGHTING Shenzhen" | split: "," %}
                      {% assign found = false %}
                      {% assign current_hour = 'now' | date: "%H" | plus: 0 %}
                      {% assign current_minute = 'now' | date: "%M" | plus: 0 %}
                      {% assign current_day_of_week = 'now' | date: "%u" | plus: 0 %}
                      {% if current_day_of_week >= 6 or current_hour >= 12 %}
                        {% assign shipping_note = "Ships next business day" %}
                      {% else %}
                        {% assign hours_left = 12 | minus: current_hour %}
                        {% if current_minute > 0 %}
                          {% assign hours_left = hours_left | minus: 1 %}
                        {% endif %}
                        {% if current_minute == 1 %}
                          {%  assign mins_txt = " min" %}
                        {% else %}
                          {%  assign mins_txt = " mins" %}
                        {% endif %}
                        {% assign minutes_left = 60 | minus: current_minute %}
                        {% if hours_left == 0 %}
                          {% assign shipping_note = '<span class="shiptimelong">Order in <br class="br2"><strong>' | append: minutes_left | append: mins_txt | append: '</strong> <br class="br1">for same day shipping.</span>' %}
                        {% else %}
                          {% if hours_left == 1 %}
                            {% assign hrs_txt = " hr " %}
                          {% else %}
                            {% assign hrs_txt = " hrs " %}
                          {% endif %}
                          {% assign shipping_note = '<span class="shiptimelong">Order in <br class="br2"><strong>' | append: hours_left | append: hrs_txt | append: minutes_left | append: mins_txt | append: '</strong> <br class="br1">for same day shipping.</span>' %}
                        {% endif %}  {% endif %}
                      {% for tag in product.tags %}
                        {% if target_tags contains tag %}
                          {% assign found = true %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                      {% assign variant = product.selected_or_first_available_variant %}
                      {% if variant.inventory_quantity > 0 %}
                        {% if found %}
                          <div class="shippingtag"><span>Ships in 1-2 business days</span></div>
                        {% else %}
                          <div class="shippingtag"><span>{{ shipping_note }}</span></div>
                        {% endif %}
                      {% else %}
                        {%- if massBB.left <= 0 and massBB.limit >= 0 and massBB.is_backorderable == false and massBB.label != "No Preorder Plan" and variant.inventory_policy == 'deny' -%}
                          <div class="shippingtag">This item just sold out, but more is on the way! <a href="https://www.eledlights.com/pages/customer-service" style="color: #1372b9; text-decoration: underline">Contact us for lead time</a><span></span></div>
                        {% else %}
                          <div class="shippingtag"><span></span></div>
                        {% endif %}
                      {% endif %}
                    </em>
                  </div>
                  <script>
                  function updateShippingNote() {
                      var current_date = new Date();
                      var current_hour = current_date.getHours();
                      var current_minute = current_date.getMinutes();
                      var current_day_of_week = current_date.getDay();
                  
                      var shipping_note = "";
                  
                      if (current_day_of_week >= 6 || current_hour >= 12) {
                          shipping_note = "Ships next business day";
                      } else {
                          var hours_left = 12 - current_hour - 1;
                          var minutes_left = 60 - current_minute;
                  
                          if (hours_left > 0) {
                              shipping_note = 'Order within <br class="br2"><strong>' + hours_left + ' hr ' + minutes_left + ' mins</strong> <br class="br1">for same day shipping.';
                          } else {
                              shipping_note = 'Order within <br class="br2"><strong>' + minutes_left + ' mins</strong> <br class="br1">for same day shipping.';
                          }
                      }
                  
                      var div = document.querySelector('.over_button_text');  // select the div by its class
                      var span = div.querySelector('.shippingtag span');  // select the span inside the div
                      var current_text = span.textContent;  // get the current text from the span
                      
                      if (current_text.startsWith("Order within") || current_text.startsWith("Ships next")) {
                          span.innerHTML = shipping_note;
                      }
                  
                      setTimeout(updateShippingNote, 60 * 1000);  // update every minute
                  }
                  
                  // Call the function as soon as the page loads
                  updateShippingNote();
                  </script>
                  {%  comment %}END Shipping Time Frame{% endcomment %}
                  
                  <product-payment-container form-id="{{ product_form_id }}" {% if update_url %}id="MainPaymentContainer"{% endif %} class="product-form__payment-container" {{ block.shopify_attributes }}>
                    {%- if quickview == "yes" and currentVariant.available -%}
                        {%- if massBB.status == "backordered" and massBB.left <= 0 and massBB.limit >= 0 and massBB.is_backorderable == true -%}
                          <button class="product-form__add-button button button--primary button--full mas-backstock-preorder-btn mas-backstock-cstm-preorder-btn" type="submit" mas-backstock-button="true" id="AddToCart" style="display: block;">{{ shop.metafields.mas_bb_config.settings.value.display_preorder }}</button>
                        {%- else -%}
                            <button id="AddToCart" type="submit" is="loader-button" {% unless block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}data-use-primary{% endunless %} data-product-add-to-cart-button data-button-content="{% if product.template_suffix == 'pre-order' %}{{ 'product.form.pre_order' | t | escape }}{% else %}{{ 'product.form.add_to_cart' | t | escape }}{% endif %}" class="product-form__add-button button {% unless product.selected_or_first_available_variant.available %}button--ternary{% else %}{% if block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}button--secondary{% else %}button--primary{% endif %}{% endunless %} button--full" {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                            {%- if product.selected_or_first_available_variant.available -%}
                                {%- if product.template_suffix == 'pre-order' -%}
                                {{- 'product.form.pre_order' | t -}}
                                {%- else -%}
                                {{- 'product.form.add_to_cart' | t -}}
                                {%- endif -%}
                            {%- else -%}
                                {{- 'product.form.sold_out' | t -}}
                            {%- endif -%}
                            </button>
                        {%- endif -%}
                    {% else %}
                        <button id="AddToCart" type="submit" is="loader-button" {% unless block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}data-use-primary{% endunless %} data-product-add-to-cart-button data-button-content="{% if product.template_suffix == 'pre-order' %}{{ 'product.form.pre_order' | t | escape }}{% else %}{{ 'product.form.add_to_cart' | t | escape }}{% endif %}" class="product-form__add-button button {% unless product.selected_or_first_available_variant.available %}button--ternary{% else %}{% if block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}button--secondary{% else %}button--primary{% endif %}{% endunless %} button--full" {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                        {%- if product.selected_or_first_available_variant.available -%}
                            {%- if product.template_suffix == 'pre-order' -%}
                            {{- 'product.form.pre_order' | t -}}
                            {%- else -%}
                            {{- 'product.form.add_to_cart' | t -}}
                            {%- endif -%}
                        {%- else -%}
                            {{- 'product.form.sold_out' | t -}}
                        {%- endif -%}
                        </button>
                    {%- endif -%}
                    {%- if block.settings.show_payment_button and template.suffix != 'quick-buy-popover' -%}
                      <div id="outer-payment-bttn">
                        {{ form | payment_button }}
                      </div>
                        <style>
                          #shopify-section-{{ section.id }} .shopify-payment-button__more-options {
                            display: none;
                          }
                        </style>
                        {%- unless product.selected_or_first_available_variant.available -%}
                        <style>
                            #shopify-section-{{ section.id }} .shopify-payment-button {
                              display: none;
                            }
                        </style>
                        {%- endunless -%}
                    {%- endif -%}
                    {% comment %}Request Bulk Quote{% endcomment %}
                    {% assign onlySku = product.selected_or_first_available_variant.sku | split: ' ' %}
                    {% for part in onlySku %}
                      {% if forloop.first %}
                        {% assign onlySku = part | strip %}
                      {% endif %}
                    {% endfor %}
                    <div class="underbutton_quicklinks">
                      <a href="/pages/bulk-order-request-form?sku={{ onlySku }}" class="product-form__add-button button button--primary button--full" target="_blank">Request Bulk Quote</a>
                    </div>
                    {% comment %}END Request Bulk Quote{% endcomment %}
                  </product-payment-container>
                {%- endform -%}
              </div>
              {%- if quickview == "yes" and currentVariant.available -%}
                {%- if massBB.status == "backordered" and massBB.left < 1 and massBB.limit > 0 and massBB.is_backorderable -%}
                  <div mas-backstock-label="true" class="mas-backstock-preorder-label mas-backstock-cstm-preorder-label" style="display: block;">{{ shop.metafields.mas_bb_config.settings.value.display_preorder }}: {{ massBB.label }}</div>
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          </div>
            {%  comment %}END BUY BUTTON{% endcomment %}
            {%  comment %}QUICK LINKS{% endcomment %}
          {% comment %}
            <div class="quicklinks">
              {% assign onlySku = product.selected_or_first_available_variant.sku | split: ' ' %}
              {% for part in onlySku %}
                {% if forloop.first %}
                  {% assign onlySku = part | strip %}
                {% endif %}
              {% endfor %}

              
              {% assign rebateLink = "javascript:window.open('https://www.eledlights.com/pages/rebate-assistant?id=" | append: onlySku | append:"','_blank')" %}
              {%- if product.tags contains "DLC 5.1" or product.tags contains "DLC 5.0" -%}
                {%- if product.selected_or_first_available_variant.metafields.data.dlc_product_id.value != NULL -%}
                  {%- if product.tags contains "High Bay" and product.tags contains "Fixture" -%}
                    <!--<a class="product-form__add-button link" href={{rebateLink}}>Find&nbsp;Rebates</a>,&nbsp;-->
                    {%- capture link1 -%}<a href="/pages/bulk-order-request-form?sku={{ current_variant.sku }}" class="product-form__add-button link linewrapper">Request&nbsp;Bulk&nbsp;Quote</a>{%- endcapture %}
                    {%- capture link2 -%}<a class="product-form__add-button link linewrapper" href="javascript:window.open('/pages/free-high-bay-lighting-layout','_blank')">Get&nbsp;a&nbsp;Layout</a>{%- endcapture %}
                  {%- else -%}
                    <!--<a class="product-form__add-button link" href={{rebateLink}}>Find&nbspRebates</a>-->
                    {%- capture link1 -%}<a href="/pages/bulk-order-request-form?sku={{ current_variant.sku }}" class="product-form__add-button link linewrapper">Request&nbsp;Bulk&nbsp;Quote</a>{%- endcapture -%}
                  {%- endif -%}
                {%- endif -%}
              {%- elsif product.tags contains "High Bay" and product.tags contains "Fixture" -%}
                {%- capture link2 -%}<a class="product-form__add-button link linewrapper" href="javascript:window.open('/pages/free-high-bay-lighting-layout','_blank')">Get&nbsp;a&nbsp;Layout</a>{%- endcapture -%}
              {%- endif -%}
              {%- if product.type == "LED" or product.type == "Grow Light" -%}
                {%- capture link3 -%}<a class="product-form__add-button link linewrapper" href="javascript:void(0);" onClick="doLinkToCalc()">Calculate&nbsp;Savings</a>{%- endcapture -%}
                <script>
                {% for variant in product.variants %}
                    {% if product.selected_or_first_available_variant.id == variant.id %}
                        {% assign vwatts = variant.metafields.data.variant_dlc_wattage %}
                        {% assign vsku = variant.sku %}
                        {% assign prodprice = variant.price %}
                    {% endif %}
                {% endfor %}
                var vwatts = "{{ vwatts }}";
                var pwatts = "{{ product.metafields.data.spec_wattage }}";
                var prodprice = "{{ prodprice }}";
                var vsku = "{{ vsku }}";
                /* find pack type - (Pack of ##) or (## Pack) */
                if(vsku.includes("Pack)")) {
                    var vtpacka = vsku.split(' (');
                    var vtpack = vtpacka[1].split(' ');
                    var vpack = parseInt(vtpack[0]);
                } else {
                  var vtpack = vsku.split(' (Pack of ');
                  var vpack = parseInt(vtpack[1]);
                }
                var rwatts = "{{ product.metafields.data.spec_replaces_wattage }}";
                if(isNaN(vpack)) { vpack = 1; }
                if(vwatts == "") { 
                    var tmpwatts = pwatts; 
                } else {
                    var tmpwatts = vwatts;
                }
                var tmpwatts2 = tmpwatts.split("W");
                if(tmpwatts2.length == 1) {
                    vwatts = tmpwatts2;
                } else {
                    vwatts = tmpwatts2[0];
                }
                if(rwatts != "") { 
                    var rwatts1 = rwatts.split("W");
                    if(rwatts1.length >1 && rwatts1[1] != '') {
                        rwatts = rwatts1[1].replace( /[^0-9]/g, '' );
                    } else {
                        rwatts = rwatts1[0].replace( /[^0-9]/g, '' );
                    }
                } else {
                    rwatts=0;
                }
                function doLinkToCalc() {
                    var urllink = "/pages/energy-savings-calculator?w="+vwatts+"&c="+prodprice/100/vpack+"&q="+vpack*$('.product-form__quantity .quantity-selector__input').val()+"&r="+rwatts;
                    window.open(urllink, '_blank');
                    return false;
                }
                </script>
            {%- endif -%}

            {%  assign looking = "<em>Looking for more? </em>" %}
            {%- assign do-or = " or&nbsp;" -%}
            {%- assign do-comma = ",&nbsp;" -%}
            
            {% assign linkcounter = 0 %}
            {% if link1.first %}
              {% assign linkcounter = linkcounter | plus: 1 %}
            {% endif %}
            {% if link3.first %}
              {% assign linkcounter = linkcounter | plus: 1 %}
            {% endif %}
            {% if link2.first %}
              {% assign linkcounter = linkcounter | plus: 1 %}
            {% endif %}
            {% case linkcounter %}
              {% when 1 %}
                {{ looking }}{{ link1 }}{{ link2 }}{{ link3 }}
              {% when 2 %}
                {% if link1.first %}
                  {{ looking }}{{ link1 }}{{ do-or }}{{ link2 }}{{ link3 }}
                {% else %}
                  {{ looking }}{{ link2 }}{{ do-or }}{{ link3 }}
                {% endif %}
              {%  when 3 %}
                  {{ looking }}{{ link1 }}{{ do-comma }}{{ link2 }}{{ do-or }}{{ link3 }}
            {% endcase %}

            {%- assign current_variant = product.selected_or_first_available_variant -%}
            </div>
              <style>
                  .quicklinks {
                    margin-top: 20px;
                    font-size: 15px;
                  }
                  .popover__content .quicklinks {
                    margin-bottom: 120px;
                  }
                  a.product-form__add-button.link {
                      color: blue;
                      font-weight: bold;
                  }
              </style>
              {%  comment %}END QUICK LINKS{% endcomment %}
          </div>
          {% endcomment %}
          {% comment %} -- REMOVED
          <div class="stock-info">
    		  {% if number_bundle_items == 1 %}
    			{% for bundled_variant in bundled_variants %}Sold in packs of {{ bundled_variant.quantity_in_bundle }}{% endfor %}
    		  {% endif %}
          </div>
          {% endcomment %}
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      PRODUCT DESCRIPTION
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'description' -%}
        {%- if product.description != blank -%}
          <div class="product-form__description rte" {{ block.shopify_attributes }}>
            {{- product.description -}}
          </div>
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      INVENTORY
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      {%- when 'inventory' -%}
        {%- if product.template_suffix != 'pre-order' and product.available or product.selected_or_first_available_variant.incoming -%}
          <product-inventory form-id="{{ product_form_id }}" {% unless product.selected_or_first_available_variant.available or product.selected_or_first_available_variant.incoming %}hidden{% endunless %} class="product-form__inventory-wrapper" {{ block.shopify_attributes }}>
            {%- if product.selected_or_first_available_variant.available -%}
              {%- if product.selected_or_first_available_variant.inventory_management and product.selected_or_first_available_variant.inventory_policy == 'deny' and product.selected_or_first_available_variant.inventory_quantity <= block.settings.low_inventory_threshold and block.settings.low_inventory_threshold > 0 -%}
                <span class="inventory inventory--low">{{ 'product.form.low_stock_with_quantity_count' | t: count: product.selected_or_first_available_variant.inventory_quantity }}</span>
              {%- else -%}
                {%- if product.selected_or_first_available_variant.inventory_policy == 'continue' and product.selected_or_first_available_variant.inventory_quantity <= 0 and product.selected_or_first_available_variant.requires_shipping -%}
                  {%- if product.selected_or_first_available_variant.incoming -%}
                    {%- capture next_incoming_date -%}{{ product.selected_or_first_available_variant.next_incoming_date | date: format: 'date' }}{%- endcapture -%}
                    <span class="inventory inventory--low">{{ 'product.form.incoming_stock' | t: next_incoming_date: next_incoming_date }}</span>
                  {%- else -%}
                    <span class="inventory inventory--low">{{ 'product.form.oversell_stock' | t }}</span>
                  {%- endif -%}
                {%- else -%}
                  <span class="inventory inventory--high">{{ 'product.form.in_stock' | t }}</span>
                {%- endif -%}
              {%- endif -%}
            {%- elsif product.selected_or_first_available_variant.incoming -%}
              {%- capture next_incoming_date -%}{{ product.selected_or_first_available_variant.next_incoming_date | date: format: 'date' }}{%- endcapture -%}
              <span class="inventory inventory--low">{{ 'product.form.incoming_stock' | t: next_incoming_date: next_incoming_date }}</span>
            {%- endif -%}

            <script type="application/json">
              {
                {%- for variant in product.variants -%}
                  {%- capture inventory_message -%}
                    {%- if variant.available -%}
                      {%- if variant.inventory_management and variant.inventory_policy == 'deny' and variant.inventory_quantity <= block.settings.low_inventory_threshold and block.settings.low_inventory_threshold > 0 -%}
                        <span class="inventory inventory--low">{{ 'product.form.low_stock_with_quantity_count' | t: count: variant.inventory_quantity }}</span>
                      {%- else -%}
                        {%- if variant.inventory_policy == 'continue' and variant.inventory_quantity <= 0 and variant.requires_shipping -%}
                          {%- if product.selected_or_first_available_variant.incoming -%}
                            {%- capture next_incoming_date -%}{{ product.selected_or_first_available_variant.next_incoming_date | date: format: 'date' }}{%- endcapture -%}
                            <span class="inventory inventory--low">{{ 'product.form.incoming_stock' | t: next_incoming_date: next_incoming_date }}</span>
                          {%- else -%}
                            <span class="inventory inventory--low">{{ 'product.form.oversell_stock' | t }}</span>
                          {%- endif -%}
                        {%- else -%}
                          <span class="inventory inventory--high">{{ 'product.form.in_stock' | t }}</span>
                        {%- endif -%}
                      {%- endif -%}
                    {%- elsif variant.incoming -%}
                      {%- capture next_incoming_date -%}{{ variant.next_incoming_date | date: format: 'date' }}{%- endcapture -%}
                      <span class="inventory inventory--low">{{ 'product.form.incoming_stock' | t: next_incoming_date: next_incoming_date }}</span>
                    {%- endif -%}
                  {%- endcapture -%}

                  "{{ variant.id }}": {{ inventory_message | json }}{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              }
            </script>
          </product-inventory>
        {%- endif -%}

      {%- comment -%}
      ----------------------------------------------------------------------------------------------------------------
      BUY BUTTONS
      ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
{% comment %}
      {%- when 'buy_buttons' -%}
        {%- if request.page_type != 'password' -%}
          <div class="product-form__buy-buttons" {{ block.shopify_attributes }}>
            {%- form 'product', product, is: 'product-form', id: product_form_id -%}
              <input type="hidden" disabled name="id" value="{{ product.selected_or_first_available_variant.id }}">

              <product-payment-container form-id="{{ product_form_id }}" {% if update_url %}id="MainPaymentContainer"{% endif %} class="product-form__payment-container" {{ block.shopify_attributes }}>
                <button id="AddToCart" type="submit" is="loader-button" {% unless block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}data-use-primary{% endunless %} data-product-add-to-cart-button data-button-content="{% if product.template_suffix == 'pre-order' %}{{ 'product.form.pre_order' | t | escape }}{% else %}{{ 'product.form.add_to_cart' | t | escape }}{% endif %}" class="product-form__add-button button {% unless product.selected_or_first_available_variant.available %}button--ternary{% else %}{% if block.settings.show_payment_button and template.suffix != 'quick-buy-popover' %}button--secondary{% else %}button--primary{% endif %}{% endunless %} button--full" {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                  {%- if product.selected_or_first_available_variant.available -%}
                    {%- if product.template_suffix == 'pre-order' -%}
                      {{- 'product.form.pre_order' | t -}}
                    {%- else -%}
                      {{- 'product.form.add_to_cart' | t -}}
                    {%- endif -%}
                  {%- else -%}
                    {{- 'product.form.sold_out' | t -}}
                  {%- endif -%}
                </button>

                {%- if block.settings.show_payment_button and template.suffix != 'quick-buy-popover' -%}
                  {{ form | payment_button }}

                  {%- unless product.selected_or_first_available_variant.available -%}
                    <style>
                      #shopify-section-{{ section.id }} .shopify-payment-button {
                        display: none;
                      }
                    </style>
                  {%- endunless -%}
                {%- endif -%}
              </product-payment-container>
            {%- endform -%}
          </div>
        {%- endif -%}

        {% assign onlySku = product.selected_or_first_available_variant.sku | split: ' ' %}
        {% for part in onlySku %}
          {% if forloop.first %}
            {% assign onlySku = part | strip %}
          {% endif %}
        {% endfor %}
      <em>Looking for more? </em>
      {% assign rebateLink = "window.open('https://www.eledlights.com/pages/rebate-assistant?id=" | append: onlySku | append:"','_blank')" %}
        {% if product.tags contains "DLC 5.1" or product.tags contains "DLC 5.0" %}
          {% if product.selected_or_first_available_variant.metafields.data.dlc_product_id.value != NULL %}
            {% if product.tags contains "High Bay" and product.tags contains "Fixture" %}
              <div style="display: flex; justify-content: space-between;">
                <!--<button class="product-form__add-button button button--ternary" style="background:#ececec; width:49%; height:52px; line-height: 20px;" onclick={{rebateLink}} type="button">Find Rebates</button>-->
                <button class="product-form__add-button button button--ternary" style="background:#ececec; width:49%; height:52px; line-height: 20px;" onclick="window.open('/pages/free-high-bay-lighting-layout','_blank')" type="button">Get a Layout</button>
              </div>
            {% else %}
              <!--<button class="product-form__add-button button button--ternary button--full" style="background:#ececec;  height:52px; line-height: 20px;" onclick={{rebateLink}} type="button">Find Rebates</button>-->
            {% endif %}
          {% endif %}
        {% elsif product.tags contains "High Bay" and product.tags contains "Fixture" %}
          <button class="product-form__add-button button button--ternary button--full" style="background:#ececec;  height:52px; line-height: 20px;" onclick="window.open('/pages/free-high-bay-lighting-layout','_blank')" type="button">Get a Layout</button>
        {% endif %}

  
        {%- if template.suffix != 'quick-buy-popover' -%}
          <store-pickup form-id="{{ product_form_id }}" class="product-form__store-availability-container">
            {%- render 'store-availability', product_variant: product.selected_or_first_available_variant -%}
          </store-pickup>
        {%- endif -%}
{% endcomment %}
    {%- endcase -%}
  {%- endfor -%}

  {%- comment -%}
  IMPLEMENTATION NOTE: under rare circumstances, merchant may want to show selectors but hide the add to cart button. This
  is however problematic as elements changed based on this. So if we detect there is no buy buttons block, we add an empty one
  {%- endcomment -%}

  {%- assign buy_buttons_block = section.blocks | where: 'type', 'buy_buttons' | first -%}

  {%- if buy_buttons_block == blank -%}
    {%- form 'product', product, is: 'product-form', id: product_form_id -%}
      <input type="hidden" disabled name="id" value="{{ product.selected_or_first_available_variant.id }}">
    {%- endform -%}
  {%- endif -%}
</div>

{%- if template.suffix == 'quick-buy-drawer' -%}
  <div class="product-form__view-details">
    <a href="{{ product.url }}" class="link text--subdued">{{ 'product.general.view_details' | t }}</a>
  </div>
{%- endif -%}

{%- comment -%}
IMPLEMENTATION NOTE: if during the iteration of the options we have found an option matching a size chart, we add it here
{%- endcomment -%}

{%- if found_size_option and size_chart_page != blank -%}
  {%- comment -%}Drawer is for tablet and desktop{%- endcomment -%}
  <drawer-content id="product-{{ section.id }}-{{ product.id }}-size-chart-drawer" class="drawer drawer--large hidden-phone">
    <span class="drawer__overlay"></span>

    <header class="drawer__header">
      <p class="drawer__title heading h6">{{ size_chart_page.title }}</p>

      <button type="button" class="drawer__close-button tap-area" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
        {%- render 'icon' with 'close' -%}
      </button>
    </header>

    <div class="drawer__content drawer__content--padded-start">
      <div class="rte">
        {{- size_chart_page.content -}}
      </div>
    </div>
  </drawer-content>

  {%- comment -%}Popover is for mobile{%- endcomment -%}
  <popover-content id="product-{{ section.id }}-{{ product.id }}-size-chart-popover" class="popover hidden-lap-and-up">
    <span class="popover__overlay"></span>

    <header class="popover__header">
      <p class="popover__title heading h6">{{ size_chart_page.title }}</p>

      <button type="button" class="popover__close-button tap-area tap-area--large" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
        {%- render 'icon' with 'close' -%}
      </button>
    </header>

    <div class="popover__content">
      <div class="rte">
        {{- size_chart_page.content -}}
      </div>
    </div>
  </popover-content>
{%- endif -%}

<script>
  //Looks at the document and continues when it finds an element with the id "layout-03"
  var observer = new MutationObserver(function(mutations) {
   const targetNode = document.getElementById('layout-03');
   if (document.contains(targetNode)) {    
      hideUSD('spice-spa-addon-price-main', 'USD');

      var prodHandles = {};
      var i = 0;
      for(const child of targetNode.children) {
        prodHandles[i] = child.children[1].children[0].children[0].href;
        i++;
      }

      getPreorderMetafields(prodHandles).then((text) => {
        var j = 0;
        //console.log(text);

        //Find how many of the accessories are pre-orders
        var totalResponses = 0;
        var lastResponse = text[0];
        for(const preOrderText of text) {
          if(preOrderText && preOrderText == lastResponse) {
            totalResponses++;
            lastResponse = preOrderText;
            //console.log(totalResponses);
          }
        }

        //If all of the accessories are preorders, add the text to the "Choose Your Bracket" line. Otherwise, add the text to each accessory
        if(totalResponses == text.length) {
          targetNode.previousSibling.style.marginBottom = '-10px';
          var preorderText = document.createElement("span");
          preorderText.classList.add("preorder-text");
          preorderText.innerText = "(Pre-Order: " + text[j] + ")"; 
          
          targetNode.previousSibling.after(preorderText);
        } else {
          for(const child of targetNode.children) {
            if(text[j]){
              var preorderText = document.createElement("span");
              preorderText.classList.add("preorder-text");
              preorderText.innerText = "(Pre-Order: " + text[j] + ")";
              child.children[1].children[0].children[0].after(document.createElement("br"));
              child.children[1].children[0].children[1].after(preorderText);
            }
            j++;
          }
        }
      });
     
      observer.disconnect();
   }
  });

  const getPreorderMetafields = async (prodHandles) => {
    const response = await fetch('https://shopapps.mannsmt.com/eled-apps/getPreorderMetafield.php', {
      method: 'POST',
      body: JSON.stringify(prodHandles),
    });
  
    const answer = await response.json();
    return answer;
  }

  function hideUSD(elementClass, substring) {
    var addonPrice = document.getElementsByClassName(elementClass);
    var regex = new RegExp(substring, 'gi');
    var hiddenSpan = '<span style="display:none;">$&</span>';
    for (let i=0; i<addonPrice.length; i++) {
      var content = addonPrice[i].innerHTML
      var newContent = content.replace(regex, hiddenSpan);
      addonPrice[i].innerHTML = newContent;
    }                    
  }

observer.observe(document, {attributes: false, childList: true, characterData: false, subtree:true});
</script>